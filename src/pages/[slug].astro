---
// src/pages/[slug].astro
import { CVDataSchema, type CVData } from '../utils/schemas/cv-schema';
import { transformLegacyData } from '../utils/data-loader';
import ResumeLayout from '../layouts/ResumeLayout.astro';
import Header from '../components/sections/Header.astro';
import About from '../components/sections/About.astro';
import WorkExperience from '../components/sections/WorkExperience.astro';
import Skills from '../components/sections/Skills.astro';
import Education from '../components/sections/Education.astro';

export async function getStaticPaths() {
  // Load resume data files from data directory
  const dataFiles = import.meta.glob('../data/*.json');
  const paths = [];

  for (const path in dataFiles) {
    const data = (await dataFiles[path]()) as { default: any };
    const slug = path.split('/').pop()?.replace('.json', '') || 'resume';

    try {
      // Transform legacy data structure to current schema
      const transformedData = transformLegacyData(data.default);
      const validatedData = CVDataSchema.parse(transformedData);

      paths.push({
        params: { slug },
        props: { cvData: validatedData },
      });
    } catch (error) {
      console.error(`Invalid data in ${path}:`, error);
    }
  }

  return paths;
}

interface Props {
  cvData: CVData;
}

const { cvData } = Astro.props;
const { basics, about, work, education, skills, certificates, projects } =
  cvData;

const pageTitle = `${basics.name} - ${basics.label}`;
const pageDescription = about.summary.substring(0, 160) + '...';
---

<ResumeLayout title={pageTitle} description={pageDescription} theme="professional">
  <Header basics={basics} />
  <About about={about} />

  {work && work.length > 0 && <WorkExperience work={work} />}

  {skills && skills.length > 0 && <Skills skills={skills} />}

  {education && education.length > 0 && <Education education={education} />}

  <!-- Add other sections as needed -->
</ResumeLayout>
